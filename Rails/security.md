# セキュリティ

## セッション

### セッションハイジャック
セッションIDを盗んでユーザーになりすまして認証突破

### セッションハイジャック等の攻撃方法
- セッションハイジャック：cookieの盗聴（セキュリティ弱いネットワーク ex. 暗号化されてない無線LAN）
 → 予防策：クライアントのトラフィック傍受を防ぐためにSSLによる安全な接続が必要
- XSSの主な目的がユーザーのcookieを盗むこと
- 攻撃者が自分の知らないcookieを盗みとる代わりに、標的のcookieを攻撃者が知っているcookieのセッションIDに固定してしまうという攻撃方法も（＝セッション固定攻撃。XSSによってJSコードのインジェクションを行い、セッションIDを埋め込む。）
- cookieを盗むのは、営利目的が主
- セッションハイジャック、セッション固定の対応策：`reset_session`。ログイン成功後に古いセッションを無効にし、新しいセッションIDを発行。

### CookieStore
- CookieStore: クライアント側のcookieにセッションハッシュを保存する仕組みにおける、Railsのセッションストレージ。
- セッションデータの保管場所を暗号化している。test環境とdevelopment環境ではアプリケーション名から`secret_key_base`を導出。それ以外の環境では、`config/credentials.yml.enc`にあるランダムな鍵を使わなければならない。

## CSRF（クロスサイトリクエストフォージェリ）
認証が完了したとユーザーが信じているWebアプリケーションのページに、悪意のあるコードやリンクを仕込む。
セッションがタイムアウトしていなければ、攻撃者は本来認証されていないはずのコマンドを実行できてしまう。
### CSRFの詳細
攻撃者が`.../project/1/destroy`などアプリのリソースを狙ったコマンドをどこか（画像やリンクなどの形で。アプリと同一ドメインでなくていい）に仕込むと、そこにユーザーがアクセスした際にブラウザが画像・リンクなどを読み出そうとしてクライアントに保存されているセッションIDを含んだcookieを一緒に送ってしまう。結果、ユーザーが意図せずしてリソースの操作が行われてしまう。
### CSRFの対策
- GETとPOSTを適切に使う
- 必須セキュリティトークンを導入する。（＝自分のサイトだけが知っており、他のサイトは知らないもの。フォーム・Ajaxリクエストにはこのセキュリティトークンを含め、サーバー側でこれを検証）Railsでは`protect_from_forgery with: :exception`がデフォルトで含まれている。

## リダイレクトとファイル
### リダイレクト
- リダイレクト用のURLの一部をユーザーが入力できるようにすると脆弱性が生まれてしまう
- 攻撃方法
  - ユーザーを本物そっくりの偽Webサイトにリダイレクトさせる（＝フィッシング）
- 対応策
  - リダイレクトするURL（の一部）をユーザーが入力できないようにする
  - URLをリダイレクトする場合は、許可リストまたは正規表現でチェックする

### ファイル
- 攻撃方法
  - 攻撃者が危険なファイル名をつけると、サーバーのファイルを上書きされてしまったり（ex. `../../../etc/passwd`）
  - 実行可能なコードを送り込む（php, cgi拡張子で`/public`ディレクトリに置くと、そのファイルを誰かがダウンロードした時にコードが実行されてしまう）

- 対応策
  - ユーザーが選択・入力できるファイル名（またはその一部）は必ずフィルタ
  - ファイル名が有効であるかどうか（指定された文字だけが使われているかどうか）をチェック（＝ 許可リスト的アプローチ ↔︎ 禁止リスト的アプローチは抜け穴ができる）
  - ファイルのアップロードの処理は非同期に（同期的に処理するとDos攻撃の脆弱性あり）


## 参考
[Rails セキュリティガイド](https://railsguides.jp/security.html)
