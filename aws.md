## 参考
- [AWS：ゼロから実践するAmazon Web Services。手を動かしながらインフラの基礎を習得](https://www.udemy.com/course/aws-and-infra/learn/lecture/14781780)

## インフラができるようになるメリット
- 自分でサービスを作れる
  - 自分自身でインフラを構築し、サービスをリリースできる
  - 開発する際のテスト環境を自分で作れるようになる
  - 高額なPaaSを利用する必要がなくなる
- 課題に対してシステム全体で対応できる
  - 障害があったときに、どこに問題があるか、切り分けられるように
  - 対応策を考えるときに、アプリケーションだけでなく、システム全体で対応できるように

## インフラ構築のやり方
1. サーバーの構成
   1. どのようなサーバーが必要かを考える
      1. サーバー：各サーバー用OSをインストールしたコンピュータ
   2. サーバーを設置する
   3. サーバーのOSをインストールし、各種設定を行う
   4. 必要なソフトウェアをインストールし、設定する
      1. 例）WebサーバならApache、データベースサーバならMySQL


2. ネットワークの構成
   1. 構築したサーバーをネットワークに接続する
      1. ネットワークで使用するIPアドレスの範囲を決める
      2. サーバーにIPアドレスを割り当てる
      3. ドメイン名とIPアドレスの対応を割り当てる

## AWSとは
- Amazon社が提供する世界最大級のクラウドサービス
  - クラウド上でサーバやネットワークを構築するサービス
- サービスが豊富＆高負荷に耐えられる信頼性の高いシステムを少ない手間（フルマネージド）で運用できる
  - EC2：仮想サーバ
  - RDS：仮想DB
- リソースが柔軟
  - 必要なときに必要な分だけ調達できる
- 従量課金
  - 費用対効果に優れている

## インフラとは
- サーバーやネットワークのこと
  - サーバー：クライアントに対してサービスを提供するコンピュータ
  - ネットワーク：複数のコンピュータをつないで、データを送受信できるようにするもの
- システムやサービスの基盤となる設備
  
## クラウドとは
- クラウド（コラウドコンピューティング）とは、ネットワークを利用していコンピューターリソースを利用する形態のこと
- オンプレミス：インフラを自前で用意し、自社で所有管理
  - クラウド誕生前のデフォルト
  - 利点：自由度が高いこと
  - 欠点：初期コストがかかり、調達期間が必要で、サーバーの増減がしにくい
- クラウド：インフラをネットワーク経由で使用・管理する
  - 利点：初期コストが少なく、すぐに始められ、サーバーの増減が自由
  - 欠点：費用の予測がつきづらい、クラウド全体で障害が起きると対応のしようがない

## AWSの初期設定
- CloudWatchで料金アラートを設定
- IAMで作業用ユーザーを作成し、以降IAMユーザで作業（rootユーザーとは別にする）
- CloudTrailで操作ログを記録（保存期間をデフォルトの90日から永久的保存に変更）
- 管理画面＝マネジメントコンソール

## ネットワークを構築
- VPC→EC2→アプリケーションのインストール、の順
- パブリックサブネット：インターネット上に公開されているネットワーク
  - WordPress on Apache
- プライベートサブネット：インターネット上に公開されていないネットワーク
  - MySQL

### リージョン
- リージョン：AWSの各サービスが提供されている地域のこと
  - リージョンによって使えるサービスが異なる
  - 最新機能はアメリカのリージョンで利用可能
  - 日本でサービスを提供する場合は、応答時間の関係で日本のリージョンを選択すると◎
- アベイラビリティゾーン：独立したデータセンターのこと
  - 各リージョンに複数のアベイラビリティゾーンがあり、災害などで停止しないようになっている
  - 東京なら、ap-northeast-1a,c,dの３つのアベイラビリティゾーンがある

### VPC
- VPC: Virtual Private Cloud。AWS上に仮想ネットワークを作成できるサービス
- VPCを作成するリージョンを選択し、VPC内で、アベイラビリティゾーン同士のネットワークを構築
- サブネット：VPCを細かく区切ったネットワーク（インターネット上に公開するネットワークと非公開にするネットワークに区切る）。１つのアベイラビリティゾーンあたり複数のサブネットを作る＝冗長性を高める◎

### IPアドレス
- 例）10.0.0.0/16, 10.0.20.0/24
- VPC、サブネットのIPアドレスの範囲を決める
- IPアドレス：ネットワーク上の機器を識別するためのインターネット上の住所
- パブリックIPアドレス：インターネットに接続する際に使用する。重複NG。プロバイダーやサーバー事業者、AWSから貸し出される。
- プライベートIPアドレス；インターネットで使用されないIPアドレス。重複を気にせず自由に使える。
- IPアドレスはネットワーク部とホスト部に区分けすることで、範囲を表記する
  - CIDR表記：IPアドレスの後ろに「/」を書き、その後ろにネットワーク部が先頭から何ビット目までなのかを記載
    - 例）192.168.128.0/24
  - サブネットマスク表記：IPアドレスの後ろに「/」を書き、ネットワーク部を表すビットと同じ部分を1に、ホスト部を表すビットと同じ部分を０にする
    - 例）192.168.128.0/255.255.255.0

### ルーティング
- ルーター：IPアドレスの行き先を管理
  - サブネットやインターネットゲートウェイ（＝VPCとインターネットを繋ぐ仮想のルーター）間にはルーターが動いている
- ルーティング：ネットワークとネットワークがIPアドレスを通じて接続できるようにすること
- ルートテーブル：ルーティングの対応表
  - 「宛先のIPアドレス」と「次のルーター（＝ターゲット in AWS）」という書式で設定
  - local = 自身のネットワーク
  - 0.0.0.0/0 = デフォルトルート：ルートテーブルに登録されているどのアドレスにも一致しない場合の経路
  - サブネットごとに設定できる

## ネットワークの構築 実践
1. VPCを作成
2. サブネットを作成
   1. 耐障害性があがる
   2. セキュリティ強化（インターネットからの隔離）
3. ルーティングを設定
   1. インターネットゲートウェイを作成し、VPCにアタッチ
   2. ルートテーブルを作成し、パブリックサブネットに紐付け
      1. デフォルトルートをインターネットゲートウェイに割り当てたルートテーブルをパブリックサブネットに紐づけることで、パブリックサブネットからインターネットに接続できるようにする

### 設計のポイント
#### VPCの設計のポイント
- プライベートIPアドレス範囲から指定
  - VPCでは仮想のプライベートネットワーク空間を作成するので、プライベートIPアドレスの使用が推奨
- 作成後は変更できないので、大きめに設定
  - 大きさは/28から/16。/16が推奨
- オンプレミスや他VPCのレンジと重複しないように気をつける（併用して使用する場合）
  - 相互接続する可能性がある場合は、重複しないように設計

#### VPCを分割するか？
- 異なるシステムの場合はアカウントを分ける
- 本番環境、ステージング環境など環境が違う場合、同一アカウントでVPC＆リージョンを分けるとよい

#### サブネットの設計のポイント
- 将来的に必要なIPアドレス数を見積もって設定
  - /24が標準的
- サブネットの分割は、ルーティングとアベイラビリティーゾーンを基準に行う
  - サブネットに割り当てられるルートテーブルは１つ
  - インターネットアクセスの有無、拠点アクセスの有無などのルーティングポリシーに応じて分割
  - 高可用性（耐障害性）のために、２つ以上のアベイラビリティゾーンを使用する

## Webサーバーを構築　実践
1. EC2（AWSが提供する仮想サーバー）を設置
   1. ＠パブリックサブネット
2. EC2にSSHでログイン（Apacheなどのソフトウェアをインストールするため）
3. ファイアウォールを設定
4. Elastic IPアドレスでIPアドレスを固定

### EC2インスタンス
- EC2: Elastic Compute Cloudの略。AWSクラウド上の仮想サーバー
- インスタンス：EC2から立てられたサーバー
- 特徴
  - 秒単位から従量課金可能
  - サーバーの増減・スペック変更も数分で可能
  - OSより上のレイヤについては自由に設定できる
- 作成手順
  - AMIの選択
  - インスタンスタイプの選択
  - ストレージの追加
  - セキュリティグループの設定
  - SSHキーペアの設定

### AMI
- AMI: Amazon Machine Image。インスタンス起動に必要な情報が入った、OSのイメージ。サーバーのテンプレートのようなもの。

### インスタンスタイプ
- サーバーのスペックを定義したもの
- インスタンスタイプによってCPU、メモリ、ストレージ、ネットワーク帯域が異なる
- 表記構成：インスタンスファミリー(ex. m)・インスタンス世代(ex. 5)・インスタンスサイズ(ex. xlarge)

### ストレージ
- サーバーにくっつけるデータの保存場所。EBS or インスタンスストア。
- EBS：Elastic Block Store。他のインスタンスに付け替え可能。EC2インスタンスを停止してもEBSは保持可能。Snapshotを取得しS3（クラウド上のデータ保存場所）に保存可能→長期保存。OSやDBなどの永続性と耐久性が必要なデータを置く。（実際によく使われるのはこっち）
- インスタンスストア：インスタンス専用の一時的なストレージ。EC2インスタンスを停止するとクリアされる。一時ファイル、キャッシュなど失われても問題ないデータを置く。

### EC2インスタンスの設定
- 自動割り当てパブリックIP  