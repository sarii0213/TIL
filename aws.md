## 参考
- [AWSの基本・仕組み・重要用語が全部わかる教科書]()
- [AWSによるクラウド入門](https://tomomano.gitlab.io/intro-aws)

## AWSサービス かんたんまとめ

- VPC: サーバやDBなどで構成される仮想ネットワーク。

- Internet Gateway: VPCとインターネットの通信のための出入り口。(⇄)

- NAT Gateway: プライベートサブネットからインターネットに出るための中継GW＠パブリックサブネット。(→)

- AWS CLI: コマンドでAWS各サービスの操作ができる。

- AWS Credentials: 認証情報。`profile`オプションで複数アカウント切り替え可能。

- IAM: AWSのサービス/リソースへのアクセス制御。アクセスキーを認証情報として埋め込み、CLIでリソース操作が可能に。

- Session Manager: IAMポリシーを利用してマネージドインスタンスにリモートログインできる。SSHキー管理不要＆安全＆踏み台サーバ気にしなくていい。`ssm`コマンド。

- ssm + sshのよいこと：
  - IAMで認証・認可(ssm) + SSHキーで認証(ssh) と二重で制御できるので、キーペアはメンバーで共有して人の出入りのタイミングでIAMだけ適宜変更すればいい
  - セッション開始にあたって踏み台サーバやSSH接続のインバウンドポートを考慮不要(ssm)
  - scpなど自在にファイル操作コマンドを使える(ssh)
  - "ssmのみ"と"ssm＋ssh"との現時点で体感している違い：ssmだとCLI使ってVPCの外からひとつひとつコマンドを送る形になり、ssm＋sshだとインスタンスの中に入ってコード編集してコミット・プッシュみたいな細々とコマンド実行ができるのが便利なのかな？
  - 参考：[セッションマネージャー越しにSSHアクセスすると何が嬉しいのか](https://dev.classmethod.jp/articles/ssh-through-session-manager/)

- ALB: L7ロードバランシングサービス。アプリケーションのURLパスベースでルーティング。踏み台サーバ的なセキュリティ機能も持つ。

- プロキシサーバ：プライベートサブネットからインターネットに出る前の中継地点。パブリックサブネットのNAT Gatewayを経由して外の世界へ。

- CloudFront: AWS上でCDNを実現する。

- CDN：オリジンサーバとエッジ（キャッシュ）サーバで構成され、高速なコンテンツ配信とサーバの負荷分散ができる仕組み。

- API Gateway: RESTなAPIの作成・公開・管理。


## 第1章　クラウドの基礎知識
- DBサーバとストレージが別で必要なのはなぜ？
  - 性能：APサーバとDBサーバとのやりとりは高速である必要があるが、高速なストレージは高価。ストレージを分離することにより、DBサーバは低コスト化できる
  - 拡張性：DBサーバの拡張は簡単ではないが、分離されたストレージ容量の拡張は簡単
  - 可用性：DBサーバがダウンしてもストレージは独立して動作し続けられる。ストレージを冗長化することで故障対策にも。
  - セキュリティ：アクセス権限を細かく制御可能。DBサーバのみのするとか、ストレージへのアクセスでもどのデータまでOKかとか。

- Software-defined Networking：ネットワーク全体を一元的に管理するコントローラーが存在。ネットワークをより柔軟かつ効率的に管理するための技術であり、ネットワークを使う人たちにとっては、よりスムーズな通信やデータ共有が可能に。

- Application Service Provider: Saasを提供するベンダ。例）勤怠管理ができるMoney Forward

- Service Oriented Architecture: ビジネス機能を分割し、それぞれの機能をサービスとして定義することで、システムの柔軟性や再利用性、相互運用性を高めることを目的としたアプリケーションの設計手法

## 第2章 AWSの基本と全体像
- リージョンには、複数のアベイラビリティゾーン(Az)とトランジットがある
  - Az：多数のサーバからなる１つ以上のデータセンタ
  - トランジット：Azから他のAWSリージョンや企業のオンプレミス環境、インターネットへの接続を経由
  - 👉 被災・障害・セキュリティ対策をしてくれているので安心◎

- リージョンに加えて、エッジロケーション・リージョナルエッジキャッシュが存在
  - 目的：エンドユーザからのアクセス速度の向上
  - CloudFrontなどのコンテンツ配信ネットワーク（CDN）サービスを利用した際に、物理的な場所に応じて最速で接続可能なデータセンタに配置されたサーバにアクセスされる
  - 👉 アクセス速度◎

- データベースとストレージの違い
  - データの構造化：データベースはデータ構造を定義してテーブルの形式で保存できるため、複雑なクエリを使用してデータ取得可能。ストレージはファイル形式でデータ保存。
  - データのアクセス方法：データベースはSQLを使用して検索・操作可能。ストレージはプログラムやアプリケーションから直接アクセス可能。
  - データの整合性：データベースはACIDの原則に従ってデータの整合性を保つ。ストレージは整合性を保証しない。
  - スケーラビリティ：データベースは大量のデータを効率的に処理可能（with クエリ最適化・インデックス作成）。ストレージは単純な読み書きに特化しているため大量のデータを処理する場合にはストレージの性能がボトルネックになる可能性。

- AWSを使う
  - AWSは各サービスでAPIを公開している。ユーザーはAPIを実行してクラウド環境や各サービスを利用できる
  - API実行方法
    - AWS Management Console (GUI)
    - AWS CLI
    - AWS SDK: Rubyなどのアプリケーションから利用されることを想定 
  - アプリケーション開発者用ユーザーの認証情報：アクセスキーとシークレットアクセスキー
  - SLA(Service Level Agreement): クラウド提供事業者が保証するサービス品質基準に関する合意。
    - AWSのユーザー企業が顧客向けにWebサービスを提供する際に、非機能要件（セキュリティや可用性など）をクラウドベンダ（AWS）とどのような役割分担で満たすのか
    - 顧客と契約したサービス提供レベルが維持できないような障害やセキュリティインシデントが発生した場合に、その責任や対応範囲は誰がどのように担うのか
    - 責任共有モデル：AWSとAWSユーザー企業との責任境界の目安

## 第3章 ネットワーク関連のサービス
### Amazon VPC
- Virtual Private Cloud
- AWS内に仮想ネットワークを構築できるサービス
- サーバやデータベースなどで構成されるシステムのためのネットワークを、オンデマンドで迅速に構築できる
- 仮想化されたネットワークにより、さまざまなロケーションに分散しているサーバや仮想マシンイメージが、あたかも１つの場所に集中して存在しているように扱える
- VPCは複数のAzをまたいで構築できるが、サブネットは各Azごとに作成する必要がある
- VPC内のアドレスはCIDRが「/16」~「/28」の間で使用できる。ただし、各サブネットの最初の４アドレス、最後の１アドレスは予約されているため使用できない

- サブネットはパブリックサブネットとプライベートサブネットがある
  - パブリックサブネット（緑）: 外部との接続を想定。デフォルトでトラフィックを外部に送信できる。
  - プライベートサブネット（青）: リソースやデータを外部アクセスから保護する用途を想定。デフォルトでトラフィックを外部に送信できない。

- VPC内のリソースが外部通信する際は、ネットワークゲートウェイリソース（VPC外のネットワークと通信を行う際に経由する中継地点）を設置する
  - Internet GateWay: VPCとインターネットの通信用途で設置。通信元のリソースがパブリックIPアドレスを持っている必要がある。固定的に割り当てられるパブリックIPアドレス＝Elastic IP Address
  - NAT GateWay: プライベートサブネット内でインターネットへの通信を行いたい場合に、パブリックサブネットへ設置する中継用ゲートウェイ。Internet GWを介した通信は双方向のため、インターネットからVPC内への通信を許容するのに対して、NAT GWを介した通信は単方向通信であり、プライベートサブネットからインターネットへ通信することはできるが、インターネットからプライベートサブネット内へは接続不可。
  - VPN GateWay: 仮想プライベートゲートウェイは、VPCとオンプレミス環境を接続。AWS側に設置。オンプレミス側にはCustomer GWの設置が必要。
  - VPC Peering: 独立した２つのVPCを接続し、プライベートアドレスを使って相互に通信。
  - VPCエンドポイント：VPCの中からAWSのマネージドサービス（EC2, RDS, S3）にアクセスするためのサービス。S3, DynamoDBのようにリージョン単位で提供されるリソース（＝リージョンサービス）は、VPCの外にあるAWSネットワーク内に構築されているため、アクセスするにはVPCから外部へ出るかたちに。S3などはデフォルトでインターネット経由のアクセスが可能なので、Internet GWやNAT GWの設定が実行されていれば通信できるが、インターネットを経由せずにアクセスを行いたい場合は、VPCエンドポイントの設置が必要。
    - VPCエンドポイントの種類：ゲートウェイ型とインターフェース型
    - ゲートウェイ型：リージョンサービスに対応。Internet GW, NAT GWだけでなく、ルートテーブルへの設定が必要。
    - インターフェース型：リージョンサービス以外に対応。VPCエンドポイントを使用したいリソースがあるサブネットに直接アタッチし、許可する接続をセキュリティグループで設定。

- VPCのアクセス制御
  - ルートテーブル
    - 指定されたCIDR表記のアドレスで通信をルーティングするルールセットの定義
    - VPCを作成すると同時にメインルートテーブルが自動作成される
    - VPCの各サブネットは何かしらのルートテーブルに関連づられる必要があり、サブネット：ルートテーブルの関係は 1~多:1

  - セキュリティグループ
    - アクセス許可するソースやプロトコル、ポートのルール定義を作成し、EC2やRDSなどのAWSリソースに関連付けることで、ファイアウォールとして動作
    - 受信と送信の両方をリソースレベルで制御できる＆リソースをグループ化して共通のセキュリティグループを関連づけることも可能
    - 通信の状態を記録して（ステートフルに）動作し、発生した通信に対する応答通信は自動的に許可される
  - ネットワークACL（Access Control List）
    - サブネットに関連づけられ、受信と送信の両方をサブネットレベルで制御できる
    - セキュリティグループよりも広範囲な制御・設定が可能
    - 通信の状態を記録せず（ステートレスに）動作するため、応答通信にも許可の設定が必要

- GuardDutyによる脅威の検知と通知
  - GuardDuty: VPCのフローログ（＝VPCのIPトラフィック情報をキャプチャ）などから不正なアクセスを検知するサービス

### Route 53
- VPCで構築したネットワーク内のリソースに、不特定多数のユーザーをアクセスさせるために必要なDNSサービス
- ホストゾーン
  - 権威DNSサーバとしての役割
    - = ゾーンの情報を保持し、各システム/サーバからの問い合わせに応じて管理するゾーンの情報を返却する
  - ユーザーはドメインごとに「ホストゾーン」と呼ばれるDNSレコードを管理するコンテナを作成し、AWS内のリソースとドメイン名の紐付けを行う
  - パブリックホストゾーン（＝インターネット上でどのようにトラフィックをルーティングするかを指定）とプライベートホストゾーン（＝VPC内でのルーティングを指定）がある
- ルーティングポリシー
  - クライアントとシステムの距離などに応じて最も高速なレスポンスを返せるよう応答の挙動を制御できる。用途に合わせて複数選定すべし。
- ヘルスチェック
  - 管理するIPアドレスをもつリソースが正しく動作してるかを監視。ルーティングポリシーと組み合わせて障害に強い設計にできる。（=DNSフェイルオーバー）
- Route 53 Resolver
  - オンプレミスやVPC内からのリソースの名前解決要求に応じて、Route 53のパブリック/プライベートホストゾーンへフォワードする

### Elastic Load Balancing
- Application Load Balancer, Classic Load Balancer, Network Load Balancerの３サービスの総称
- ロードバランシング：あるWebサービスが複数のWebサーバやアプリケーションサーバで構成されている場合に、リクエスト要求の負荷を分散させること

- ALB
  - L7(アプリケーション層)でのルーティングが可能　＝機能的な負荷分散
  - リバースプロキシ型：応答通信もロードバランサーを経由してクライアントへ届くタイプ
  - リスナーと呼ばれるコンポーネントを作成し、使用するプロトコルとポートを設定して、ルーティングルールを設定

## 第4章　コンピューティング関連のサービス
### EC2
- Elastic Computed Cloud
- Webサービスやバッチ処理といったアプリケーションの中核的な処理を実行する他、コンテナの実行、OSSの実行、開発時のテスト実行など幅広い用途で使用
- Amazon Machine Image: EC2上で仮想サーバとして動かすゲストOS。Amazon Linuxなど。
- Cluster: Azの配置戦略の一つ。単一のAz内のできるだけ近い位置でインスタンスを配置するよう指定。インスタンス間のレイテンシーを小さく。
- IAM: EC2インスタンスから他AWSサービスへのアクセスにIAMを使った権限付与が必要。 
に必要。

## 第５章　ストレージ関連のサービス
- ブロックストレージ：
  - データをブロック単位で分割して管理
  - データアクセスにはOSが提供するファイルシステムというコンピュータがリソースを操作するための機能を使用
  - データアクセスに必要な処理によるオーバーヘッド（処理を実行する際に必要となる余分な処理）が少なく、高速なデータアクセスが可能
  - データベースやOSの起動ディスクなど、高速なデータアクセスが必要なケースに利用
  - PCやサーバに単に接続しただけdれは利用できず、OSにストレージの存在を認識させるマウントという操作が必要
- ファイルストレージ：
  - データをファイルとして、階層構造となったフォルダに保存する
  - PCやサーバでデータを共有しつつ、あたかもデータを保持しているかのように扱える
- オブジェクトストレージ：
  - 画像データや音声データなど、１つひとつのデータをオブジェクトという単位で管理する
  - 各データにURIとメタデータを付与

### S3
- Simple Storage Service
- オブジェクトストレージ
- バケット：オブジェクトの格納場所。そのままURLに。
- キー：オブジェクトに割り当てる名前。ファイル名。

## 第６章 データベース関連のサービス
- CAP定理
  - Consistency(一貫性): あるデータを読み取りしたとき、どのノードにおいても必ず最新の書き込み結果を返す。もしくはエラーを返す。
  - Availavility(可用性): システムを構成するノードに障害が発生していたとしても、常に読み込みと書き込みが可能である
  - Partition Tolerance(ネットワーク分断耐性): システムを構成するノード間の通信が一時的に分断されても、機能が継続される
  - 「原則として、２つの特性を重視すると、残りの１つが失われる」
  - RDSはCA型

### RDS
- Relational Database Service
- Multi-AZ配置：RDSは自動フェイルオーバー（＝稼働中のシステムがダウンした際に待機系のシステムに自動で切り替え）をサポートしており、Multi-AZ配置というオプションを選択することで別のAzにスタンバイデータベースを配置する冗長化構成が構築される

### IAM
- Identity Access Management

### CloudFront
- CDN(Contents Delivery Network)の機能を持つサービス
- クライアントへコンテンツを高速配信可能
- CDN
  - システムのサーバの負荷を下げつつ、コンテンツ配信を高速化する仕組み
  - オリジンサーバとエッジ（キャッシュ）サーバで構成
    - オリジンサーバ（"オリジン"）：コンテンツを配信するサーバ（Webサーバ、APサーバ）
    - エッジサーバ（"エッジロケーション"）：オリジナルサーバのコンテンツの一部を一時的に保持（キャッシュ）するサーバ。世界中に配置されており、クライアントはまずエッジサーバにアクセスする。👉 高速化＆オリジンサーバへの負荷小

### ECS
- Elastic Container Service
- Dockerコンテナをスケーラブルかつ簡単に実行/停止/管理できるコンテナ管理サービス

### API Gateway
- さまざまな規模に応じたWeb APIの作成・公開・管理を簡単に行える

### CodeCommit
- 高い可用性を備えるGitベースのソースコードリポジトリサービス

### Command Line Interface
- コマンドでAWSリソースの作成・参照・変更・削除ができる
- プロファイルを切り替えると、複数のアカウントに対して操作が可能
- `aws configure`で事前にAWSアカウントの設定が必要
  - Access Key ID: AWSアカウントとIAMユーザを一意に特定する情報
  - Secret Access Key: アクセスキーIDのパスワードに相当する情報

### Systems Manager
- EC2などの運用を効率化する
- 略称のSSMはSystems Managerの前身がSimple Systems Managerだから
- Systems Managerの管理対象となったインスタンスは「マネージドインスタンス」と呼ぶ
  - マネージドインスタンスになる条件：
    - SSMエージェントが導入されていること（SSM APIと連携して各種操作を行う。Amazon Linux等にプリインストールされてる。）
    - SSM APIへの接続経路が確保されていること（SSMエージェントとはHTTPSプロトロコルを介して通信。SGでの接続許可＆GWなど）
    - IAMロールに適切な権限が付与されていること
- セッションマネージャ
  - Webブラウザ（AWSマネジメントコンソール）やCLIからインスタンスのコマンド操作を実現する機能
  - SSHアクセスにおいて必要だった作業（通信ポートの解放、SSHアクセスのための鍵管理、プライベートサブネットに配置されたインスタンス向けの踏み台サーバの構築）が不要に


### CloudFormation
- JSONやYAML形式で記述されたテンプレートをもとに、AWSリソース基盤を自動構築するツール
- 似たサービスに、Terraformがある
- 構築されたリソースの集合をスタックと呼ぶ


***

<br>

## 参考
- [AWS：ゼロから実践するAmazon Web Services。手を動かしながらインフラの基礎を習得](https://www.udemy.com/course/aws-and-infra/learn/lecture/14781780)


## インフラができるようになるメリット
- 自分でサービスを作れる
  - 自分自身でインフラを構築し、サービスをリリースできる
  - 開発する際のテスト環境を自分で作れるようになる
  - 高額なPaaSを利用する必要がなくなる
- 課題に対してシステム全体で対応できる
  - 障害があったときに、どこに問題があるか、切り分けられるように
  - 対応策を考えるときに、アプリケーションだけでなく、システム全体で対応できるように

## インフラ構築のやり方
1. サーバーの構成
   1. どのようなサーバーが必要かを考える
      1. サーバー：各サーバー用OSをインストールしたコンピュータ
   2. サーバーを設置する
   3. サーバーのOSをインストールし、各種設定を行う
   4. 必要なソフトウェアをインストールし、設定する
      1. 例）WebサーバならApache、データベースサーバならMySQL


2. ネットワークの構成
   1. 構築したサーバーをネットワークに接続する
      1. ネットワークで使用するIPアドレスの範囲を決める
      2. サーバーにIPアドレスを割り当てる
      3. ドメイン名とIPアドレスの対応を割り当てる

## AWSとは
- Amazon社が提供する世界最大級のクラウドサービス
  - クラウド上でサーバやネットワークを構築するサービス
- サービスが豊富＆高負荷に耐えられる信頼性の高いシステムを少ない手間（フルマネージド）で運用できる
  - EC2：仮想サーバ
  - RDS：仮想DB
- リソースが柔軟
  - 必要なときに必要な分だけ調達できる
- 従量課金
  - 費用対効果に優れている

## インフラとは
- サーバーやネットワークのこと
  - サーバー：クライアントに対してサービスを提供するコンピュータ
  - ネットワーク：複数のコンピュータをつないで、データを送受信できるようにするもの
- システムやサービスの基盤となる設備
  
## クラウドとは
- クラウド（コラウドコンピューティング）とは、ネットワークを利用していコンピューターリソースを利用する形態のこと
- オンプレミス：インフラを自前で用意し、自社で所有管理
  - クラウド誕生前のデフォルト
  - 利点：自由度が高いこと
  - 欠点：初期コストがかかり、調達期間が必要で、サーバーの増減がしにくい
- クラウド：インフラをネットワーク経由で使用・管理する
  - 利点：初期コストが少なく、すぐに始められ、サーバーの増減が自由
  - 欠点：費用の予測がつきづらい、クラウド全体で障害が起きると対応のしようがない

## AWSの初期設定
- CloudWatchで料金アラートを設定
- IAMで作業用ユーザーを作成し、以降IAMユーザで作業（rootユーザーとは別にする）
- CloudTrailで操作ログを記録（保存期間をデフォルトの90日から永久的保存に変更）
- 管理画面＝マネジメントコンソール

## ネットワークを構築
- VPC→EC2→アプリケーションのインストール、の順
- パブリックサブネット：インターネット上に公開されているネットワーク
  - WordPress on Apache
- プライベートサブネット：インターネット上に公開されていないネットワーク
  - MySQL

### リージョン
- リージョン：AWSの各サービスが提供されている地域のこと
  - リージョンによって使えるサービスが異なる
  - 最新機能はアメリカのリージョンで利用可能
  - 日本でサービスを提供する場合は、応答時間の関係で日本のリージョンを選択すると◎
- アベイラビリティゾーン：独立したデータセンターのこと
  - 各リージョンに複数のアベイラビリティゾーンがあり、災害などで停止しないようになっている
  - 東京なら、ap-northeast-1a,c,dの３つのアベイラビリティゾーンがある

### VPC
- VPC: Virtual Private Cloud。AWS上に仮想ネットワークを作成できるサービス
- VPCを作成するリージョンを選択し、VPC内で、アベイラビリティゾーン同士のネットワークを構築
- サブネット：VPCを細かく区切ったネットワーク（インターネット上に公開するネットワークと非公開にするネットワークに区切る）。１つのアベイラビリティゾーンあたり複数のサブネットを作る＝冗長性を高める◎

### IPアドレス
- 例）10.0.0.0/16, 10.0.20.0/24
- VPC、サブネットのIPアドレスの範囲を決める
- IPアドレス：ネットワーク上の機器を識別するためのインターネット上の住所
- パブリックIPアドレス：インターネットに接続する際に使用する。重複NG。プロバイダーやサーバー事業者、AWSから貸し出される。
- プライベートIPアドレス；インターネットで使用されないIPアドレス。重複を気にせず自由に使える。
- IPアドレスはネットワーク部とホスト部に区分けすることで、範囲を表記する
  - CIDR表記：IPアドレスの後ろに「/」を書き、その後ろにネットワーク部が先頭から何ビット目までなのかを記載
    - 例）192.168.128.0/24
  - サブネットマスク表記：IPアドレスの後ろに「/」を書き、ネットワーク部を表すビットと同じ部分を1に、ホスト部を表すビットと同じ部分を０にする
    - 例）192.168.128.0/255.255.255.0

### ルーティング
- ルーター：IPアドレスの行き先を管理
  - サブネットやインターネットゲートウェイ（＝VPCとインターネットを繋ぐ仮想のルーター）間にはルーターが動いている
- ルーティング：ネットワークとネットワークがIPアドレスを通じて接続できるようにすること
- ルートテーブル：ルーティングの対応表
  - 「宛先のIPアドレス」と「次のルーター（＝ターゲット in AWS）」という書式で設定
  - local = 自身のネットワーク
    - サブネットにアタッチされたルーターにおけるlocal = そのサブネットのこと
    - `10.0.0.0/16 local` というのは、"そのサブネットのIPアドレス範囲（例：`10.0.10.0/24`）だったらそのサブネット宛にトラフィックを向ける"、というのを簡略化して書かれているものらしい…？
  - 0.0.0.0/0 = デフォルトルート：ルートテーブルに登録されているどのアドレスにも一致しない場合の経路
  - サブネットごとに設定できる

## ネットワークの構築 実践
1. VPCを作成
2. サブネットを作成
   1. 耐障害性があがる
   2. セキュリティ強化（インターネットからの隔離）
3. ルーティングを設定
   1. インターネットゲートウェイを作成し、VPCにアタッチ
   2. ルートテーブルを作成し、パブリックサブネットに紐付け
      1. デフォルトルートをインターネットゲートウェイに割り当てたルートテーブルをパブリックサブネットに紐づけることで、パブリックサブネットからインターネットに接続できるようにする

### 設計のポイント
#### VPCの設計のポイント
- プライベートIPアドレス範囲から指定
  - VPCでは仮想のプライベートネットワーク空間を作成するので、プライベートIPアドレスの使用が推奨
- 作成後は変更できないので、大きめに設定
  - 大きさは/28から/16。/16が推奨
- オンプレミスや他VPCのレンジと重複しないように気をつける（併用して使用する場合）
  - 相互接続する可能性がある場合は、重複しないように設計

#### VPCを分割するか？
- 異なるシステムの場合はアカウントを分ける
- 本番環境、ステージング環境など環境が違う場合、同一アカウントでVPC＆リージョンを分けるとよい

#### サブネットの設計のポイント
- 将来的に必要なIPアドレス数を見積もって設定
  - /24が標準的
- サブネットの分割は、ルーティングとアベイラビリティーゾーンを基準に行う
  - サブネットに割り当てられるルートテーブルは１つ
  - インターネットアクセスの有無、拠点アクセスの有無などのルーティングポリシーに応じて分割
  - 高可用性（耐障害性）のために、２つ以上のアベイラビリティゾーンを使用する

## Webサーバーを構築 実践
1. EC2（AWSが提供する仮想サーバー）を設置
   1. ＠パブリックサブネット
   2. public IPの自動割り当ての有効化＆network interfaceでprimary IPを追加し、private IPも付与
2. EC2にSSHでログイン（Apacheなどのソフトウェアをインストールするため）
   1. ダウンロードしたssh key(秘密鍵)は`chmod 600`でオーナー以外の読み書き権限を制限しておく←sshログインの必須条件
   2. apache(httpd.service)のインストール＆起動＆自動起動設定
3. ファイアウォールを設定
4. Elastic IPアドレスでIPアドレスを固定

### EC2インスタンス
- EC2: Elastic Compute Cloudの略。AWSクラウド上の仮想サーバー
- インスタンス：EC2から立てられたサーバー
- 特徴
  - 秒単位から従量課金可能
  - サーバーの増減・スペック変更も数分で可能
  - OSより上のレイヤについては自由に設定できる
- 作成手順
  - AMIの選択
  - インスタンスタイプの選択
  - ストレージの追加
  - セキュリティグループの設定
  - SSHキーペアの設定

### AMI
- AMI: Amazon Machine Image。インスタンス起動に必要な情報が入った、OSのイメージ。サーバーのテンプレートのようなもの。

### インスタンスタイプ
- サーバーのスペックを定義したもの
- インスタンスタイプによってCPU、メモリ、ストレージ、ネットワーク帯域が異なる
- 表記構成：インスタンスファミリー(ex. m)・インスタンス世代(ex. 5)・インスタンスサイズ(ex. xlarge)

### ストレージ
- サーバーにくっつけるデータの保存場所。EBS or インスタンスストア。
- EBS：Elastic Block Store。他のインスタンスに付け替え可能。EC2インスタンスを停止してもEBSは保持可能。Snapshotを取得しS3（クラウド上のデータ保存場所）に保存可能→長期保存。OSやDBなどの永続性と耐久性が必要なデータを置く。（実際によく使われるのはこっち） 有料。
- インスタンスストア：インスタンス専用の一時的なストレージ。EC2インスタンスを停止するとクリアされる。一時ファイル、キャッシュなど失われても問題ないデータを置く。無料。

## ドメインの登録
1. お名前.comなどのレジストラでドメインを購入
2. 購入したドメイン名でRoute53にホストゾーン（=DNSのリソースレコードの集合）を作成
3. Route53のホストゾーンのNSをお名前.comのNS設定画面に反映（=購入したドメインのNSをRoute53に変更）
   ->トップレベルドメイン(.workなど)のNSが、購入したドメイン名のDNSの問い合わせに対して、Route53のNSを返すようになる
4. 購入したドメインに紐づくIPアドレス（=ec2 public IP）を登録 by Route53でAレコード追加


## DBサーバーを構築
- private subnetにDBサーバを設置
- RDSは複数のDBサーバを複数のAZに設置することを推奨されているので、たとえ設置するDBサーバがひとつでも、複数のサブネットを用意しておく

### RDS
- フルマネージドなリレーショナルデータベース
  - フルマネージド：構築・運用の手間が軽減。AWSエンジニアによって最適な設計がなされている◎
    - ユーザーのコントロール範囲：設定グループの変更ができる。(DB parameter groups, option groups, subnet groups)
- 特徴
  - 高い可用性（マルチAZを簡単に構築可能）
    - マルチAZ：マスターとスレーブ（マスターをレプリケーションしたもの）
  - 高パフォーマンス
    - リードレプリカ（読み取り専用のレプリカ）を用意することで、読み書き・読み取りで別のDBを利用できる
  - 運用負荷の軽減
    - 自動的なバックアップ
    - 自動的なソフトウェアメンテナンス
    - 監視（各種メトリクスを60秒間隔で取得・確認）

### 作業順序
1. subnet用意
2. DB用security group作成
   1. sourceはweb server, typeはmysqlのインバウンドアクセスのみ許可
3. RDSのsubnet group作成（VPC内のサブネットの指定）
4. RDSのparameter group作成（DBの設定値を指定）
5. RDSのoption group作成（プラグインの利用などDBの機能を指定）
6. database作成
   1. 注意１：スナップショットの取得を手動で行うと、そのスナップショットは削除されることがない（自動スナップショットは30日後orRDSの削除の際に消される）
   2. 注意２：本番環境での停止はしないのが無難。理由は、停止に時間がかかる＆起動したい時にAWS側にRDSインスタンスのリソースが余っていないとしばらく起動できないことがあるから。 
7. webサーバ(EC2)からRDSに接続
   1. ec2にmysqlをインストール（https://muleif.medium.com/how-to-install-mysql-on-amazon-linux-2023-5d39afa5bf11）
   2. ec2から作成したRDSインスタンスに接続
      1. `mysql -h <rds_instance_endpoint> -u root -p`


## WordPressを構築（EC2）
- WP用のdbを作成
- WPのインストール
- WPの設定

### WP用のdbを作成
- db作成 
- user作成
  - userに全dbを操作できる権限をGRANT -> `FLUSH PRIVILEGES`

### WPのインストール
- ライブラリのインストール
  - `sudo dnf install -y php`
- WPのダウンロード
  - `wget https://ja.wordpress.org/latest-ja.tar.gz`
- WPの解凍 `tar xzvf latest-ja.tar.gz`
- wp directoryを`/var/www/html/`にcopy(apacheがHTTPリクエストを受けた時にレスポンスを返すために参照する場所)
- `/var/www/html/`内wp fileの所有者・グループを変更 `sudo chown apache:apache /var/www/html/ -R`
- apache 再起動して設定反映 `sudo systemctl restart httpd.service`

### WPの設定
- `<ec2_IP_address_or_domain_name>/wordpress`にアクセスして、rdsのmysqlの設定を入力
  - データベース名（=mysql database名）
  - ユーザー名（=mysql user名）
  - パスワード（=mysql password）
  - データベースのホスト名（＝RDSエンドポイント）


## 画像を配信 （S3 / CloudFront）
- S3 bucketの作成
- CloudFrontで画像キャッシュして配信高速化

### インフラ設計における重要な観点
- 可用性（サービスを継続的に利用できるか、サービスが落ちないこと）
- 性能・拡張性
  - 画像配信では性能にフォーカス
- 運用・保守性
- セキュリティ
- 移行性

### 画像の保存場所をWebサーバーでなくS3にする理由
- Web serverのstorageが画像でいっぱいになるのを防ぐ
- 負荷分散
- サーバーの台数を増やしやすくする
  - Web server上に画像が保存されると、web serverの台数を増やした時に画像ファイルを同期する必要があり、スケールアウト困難に
- コンテンツ配信サービスから配信することで、画像配信を高速化できる

### S3とは
- 非常に安価（0.023USD/GB・月）と高い耐久性
- 重要概念
  - バケット
  - オブジェクト
  - キー（オブジェクトの格納URLパス）
- 利用シーン
  - 静的コンテンツの配信（img画像）
  - バッチ連携用のファイル置き場
  - ログなどの出力先
  - 静的web hosting（LPなど）をS3から公開

### 作業順序
- s3 bucket作成
- s3にアクセスできるiam user作成
- wp用の画像をs3にアップロード
  - wp用のプラグインのインストール（wpからs3に画像をアップロードするため）`WP Offload Media Lite`
  - プラグインを動かすのに必要なライブラリをec2にインストール 
    - `sudo yum install -y php-xml php-gd php-devel` -> `systemctl restart httpd.service`
  - プラグインの設定

### CloudFrontとは
- オリジンサーバー（今回だとS3）上にあるコンテンツを、世界中100箇所以上にあるエッジロケーションにコピーし、そこから配信を行う
- 高速＆効率的（エッジサーバーにキャッシュされるのでオリジンサーバーに負荷をかけない）

### 作業順序
- CloudFrontのdistribution（配信ルール）の作成
  - CNAMEに`static.<独自ドメイン>`を登録
  - Custom SSL certificate からSSL証明書発行ページへ
- CloudFrontのドメインではなく、独自ドメインから配信する(SEO的にbetter)
  - Certificate ManagerでSSLサーバー証明書の発行（CloudFrontのdistributionに独自ドメインを登録するため）
    - 発行したらCNAME recordを独自ドメインのhosted zoneに登録
  - CloudFrontのdistributionに独自ドメインを登録
  - Route 53で独自ドメインのCNAMEとしてCloudFrontドメインのalternate domain name, distribution domain nameを設定（独自ドメインからCloudFrontドメインに転送するため）
  - Offload Mediaで独自ドメインを登録
    - 画像URLが独自ドメインになるように



---
ToDo:
wpのパスワードを控えておくのを忘れたので、以下を再度実行
- database delete & make it again
- wp login 
  